# **msquic-2.3+Rocca-S** branch

This branch uses Rocca-S implemented in quictls for encryption.

# Supported platform
We confirmed this software can be built on Ubuntu 22.04 LTS.


# Building MsQuic

## PowerShell Usage
For PowerShell installation instructions, see the [Build docs](./BUILD.md).

## Change branch
Change to msquic-2.3+Rocca-S branch by executing following commands:

```
git fetch
git branch -a
git checkout -b msquic-2.3+Rocca-S remotes/origin/msquic-2.3+Rocca-S
```

## Getting submodules
Get all submodulues by executing following commands:

```
git submodule update --init --recursive
```

Note that the module quictls with Rocca-S will be obrained by getting the submodule 'openssl3'


## Building with PowerShell

### Start PowerShell
For Ubuntu you can run the following:

```
pwsh
```

### Install Dependencies
For the very first time you build, it's recommend to make sure you have all the dependencies installed. You can ensure this by running:

```Powershell
./scripts/prepare-machine.ps1
```

### Running a Build
To build the code, you just need to run `build.ps1` in the `scripts` folder:

```Powershell
./scripts/build.ps1 -Tls openssl3
```

# Testing MsQuic
Note that msquic-2.3+Rocca-S contains some errors.


# MsQuic API
* For using the API, see the [API docs](./API.md) or the [Sample](../src/tools/sample/sample.c).

# Quick Start Guide
[Sample](../src/tools/sample/sample.c) provides a very simple MsQuic API sample server and client application.

## Moving to working directry
Move to the directry containing 'sample.c' by the following command:

```
cd ./src/tools/sample/
```

## Generate Self Signed Certificate
A certificate needs to be available for the server to function.

```
# Generate a key pair
openssl genrsa -out private.key 2048

# Issue a csr
openssl req -new -key private.key -out server.csr

# Issue a crt
openssl x509 -req -in server.csr -signkey private.key -out server.crt
```

## Running a Build
Build 'sample.c' by the following command to create a executable 'sample':

```
gcc  -fgnu89-inline -I ../../../src/inc/ sample.c -o sample -L ../../../artifacts/bin/linux/x64_Debug_openssl3/ -lmsquic -Wl,-rpath ../../../artifacts/bin/linux/x64_Debug_openssl3/
```

## Start the server
Start the server providing the thumbrint obtained in the previous step.

```
./sample -server -cert_file:server.crt -key_file:private.key
```

## Start the client
Start the client providing the IP address for the server. Here localhost is used as an example.

```
./sample -client -target:localhost -unsecure
```

## Console Output

Here is what the console output looks like on the server and client sides after connection is established and data flows:

### Server side
```
[conn][0x7f2db4012810] Connected
[strm][0x7f2db403f430] Peer started
[strm][0x7f2db403f430] Data received
[strm][0x7f2db403f430] Peer shut down
[strm][0x7f2db403f430] Data sent
[strm][0x7f2db403f430] All done
[conn][0x7f2db4012810] Successfully shut down on idle.
[conn][0x7f2db4012810] All done
```

### Client side
```
[conn][0x556395412060] Connecting...
[conn][0x556395412060] Connected
[strm][0x7f8d5c015b50] Starting...
[strm][0x7f8d5c015b50] Sending data...
[strm][0x7f8d5c015b50] Data sent
[conn][0x556395412060] Resumption ticket received (1799 bytes):
01000000013146CE010243E8030245C00404810000000504800100000604800100000704800100000801010E0104C0000000FF03DE1A0243E82D2D2D2D2D424547494E2053534C2053455353494F4E20504152414D45544552532D2D2D2D2D0A4D49494579414942415149434177514541684D43424342574E753353444166426277336D6B54377733563330673448517643634E316646564E5A524F516234500A58775177776E7A646E51724D467A4C3763526D70726C356E51362B4C58345A79486C626E5971686254702F5432433841754E6F45677A6C37793135377145466C0A576553536F5159434247587562772B69424149434843436A67674D564D4949444554434341666B4346416B68543953747647582B4537744F7A47674D643379680A563153324D413047435371475349623344514542437755414D455578437A414A42674E5642415954416B46564D524D774551594456515149444170546232316C0A4C564E305958526C4D534577487759445651514B4442684A626E526C636D356C644342586157526E6158527A494642306553424D644751774868634E4D6A51770A4D7A45784D4449784D6A51355768634E4D6A51774E4445774D4449784D6A5135576A42464D517377435159445651514745774A42565445544D424547413155450A4341774B553239745A533154644746305A5445684D4238474131554543677759535735305A584A755A58516756326C6B5A326C306379425164486B675448526B0A4D494942496A414E42676B71686B6947397730424151454641414F43415138414D49494243674B43415145417152515644436A62697972744F656766524738700A73356A554C6D76736C7453583457756A4954626957733737545A6D77366A4954573270396D2B62544549374473506659734B3433714F654339644A50464579490A5547324E392F696E45645168684554523261494F722B666278547870765262476661464D6B4161726F32572B7241666333683471773644634F434248666C6F530A4A703446445730776A41427A4F6F5467347044496A64394C7641744A6A4776424A65574E59476F383637486B41686E5755626A5358796E45367142784B384A510A6D614D7A336D45706D62436A4F4E716A5A676C5A5741734671614F346B6736597865784E576A4E6A38756C47756B7050596C613243666A6B796C39674F6348540A503876566F57324F6E446761686D6263632B7655457577434B66396B36753866686A71356568354C434B6B54595167556532486C71546F45364A586E6C34424B0A79774944415141424D4130474353714753496233445145424377554141344942415142766C6B4E71576D66316D6B375943696E51487A4E7A71697278445644440A776B7159676E744D6F4B2B2F3557706F417558792B6E392F533031717531394A4C4D38314F5466674D3441704A79577A4E62764F2F74794672664F745149316D0A4252766779464F464B595541432F326A785057694C5972376875626C393145666A7753375055766E627762537154506E5333375A484A522B69393762697365680A6D506636417058434F314C5734456B6F6C5A4D78556A7976317A724C4C4B5450324735767249334A2B706743637137572B346341526E5734696A5375385137690A324A66454750464C41346F46567976466F6A727A7158343037537930303365735A444E37545A5359612B61645A314D564E4C543362337730644367682F5435480A5A6C302F77596534756B6B2B4D50343363744C4A644D75484443684D4D51394146674F554737746D4C42506E66526170522F31626536357970414945414B6B450A41674963494B714341525145676745515568507235414E334755736F70564866322B6C324B786535684D77724A7053466C7766634E55396853506C4962787A460A566E4A684737574347637054504A644C443665745458706F73576256373568724E6A4431534542664477516163757946387A434871436B5A6679354F723568560A767A435363584938767A7A61564E5559764B466B58685674795074515449635A424D5258662B746366596D33674C7348336D65736232585A35714A52395963430A7662644C556359614F5867433454444A736A4933326A4F614D4E45694E46427438726945534642315551706D4570422F502F6C414938482F7752376B5169634F0A35476A3939735544327852374B733146322F4B6439354456762F343879307074504E5A777A75516976366F736256344B6545474C754B4F2F71744A38646859710A557662416571494C78764B6B756B68714955724E764E50433345334F35396C3679416A6954344C697A44346458656F5474755A4939556F7535795375426749450A46544D65544B3848416755412F2F2F2F2F37414942415A7A595731776247577A4177494248513D3D0A2D2D2D2D2D454E442053534C2053455353494F4E20504152414D45544552532D2D2D2D2D0A
[strm][0x7f8d5c015b50] Data received
[strm][0x7f8d5c015b50] Peer shut down
[strm][0x7f8d5c015b50] All done
[conn][0x556395412060] Successfully shut down on idle.
[conn][0x556395412060] All done
```

